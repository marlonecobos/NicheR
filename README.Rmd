---
output: github_document
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
always_allow_html: true # Add this line
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# NicheR: Ecological Niche Modeling and Simulation in R

<!-- badges: start -->

<!-- badges: end -->

The goal of NicheR is to provide a robust set of tools for researchers
and modelers to:

Construct and define virtual niches using ellipsoid geometries in 2D or
3D environmental dimensions.

Identify and extract suitable environmental areas based on these defined
niches from various environmental data sources (rasters, data frames).

Simulate species occurrence points within suitable habitats, offering
different sampling strategies (random, biased towards center, or biased
towards edges).

Visualize niche boundaries and simulated occurrences effectively in both
environmental (E-space) and geographic (G-space).

Inspired by the methodologies in NicheA and the virtualspecies R
package, NicheR aims to streamline the process of niche
conceptualization and data generation for ecological studies.

## Authors 

Mariana Castaneda-Guzman

Paanwaris Paansri

Connor Hughes

## Installation You can install the development version of NicheR from

GitHub with pak or remotes:

```{r}
# 1. Install devtools if you don't have it yet
# if (!require("devtools")) {
#  install.packages("devtools")
# }

# 2. Install bean from GitHub
# devtools::install_github("castanedaM/NicheR")
```

## Dependencies NicheR relies on the following R packages, which will be

installed automatically with the package: dplyr, ggplot2, ggpubr,
plotly, RColorBrewer, and terra.

### Example This is a basic example demonstrating the core functionality

of NicheR.

### 1. Load Data and Define Environmental Background We'll load NicheR and

prepare some example environmental raster data. For this, we'll use
example files that should be located in your package's inst/extdata
directory.

```{r}
library(NicheR)
library(terra)
library(ggplot2)
library(ggpubr)
library(rgl)
library(plotly)

# Access example environmental raster files from the package
# Make sure "Bio1.tif", "Bio4.tif", "Bio12.tif" exist in inst/extdata
bio_1 <- terra::rast(system.file("extdata", "Bio1.tif", package = "NicheR"))
bio_4 <- terra::rast(system.file("extdata", "Bio4.tif", package = "NicheR"))
bio_12 <- terra::rast(system.file("extdata", "Bio12.tif", package = "NicheR"))

# Stack and name the environmental layers
env_stack <- c(bio_1, bio_12, bio_4)
names(env_stack) <- c("mean_temp", "temp_seasonality", "annual_precip")

# Convert the raster stack to a data frame for E-space plotting
env_df <- as.data.frame(env_stack, xy = TRUE, na.rm = TRUE)

# Downsample for faster plotting if the background is very large
if(nrow(env_df) > 20000){
  set.seed(1234)
  env_df_plotting <- env_df[sample(1:nrow(env_df), size = 20000, replace = FALSE), ]
} else {
  env_df_plotting <- env_df
}
```

### 2. Build a 3D Ellipsoid Niche The build_ellipsoid() function creates

the core niche object by specifying its center, semi-axis lengths, and
rotation angles.

```{r}
# Define niche parameters
niche_center <- c(mean_temp = 280, temp_seasonality = 1500, annual_precip = 2000)
niche_axes <- c(100, 500, 2500) # Semi-axis lengths (breadth)
niche_angles <- c(0, 0, pi/12) # Small rotation around Z-axis

# Create the ellipsoid niche object
my_niche <- build_ellps(
  center = niche_center,
  axes = niche_axes,
  angles = niche_angles,
  n_points = 50 # Resolution for surface points
)
```

### 3. Visualize the Niche in Environmental Space plot_e_space() allows you

to visualize the environmental background and the niche ellipsoid. It
can generate both static 2D pairwise plots and interactive 3D plots.

#### 3.1. 2D Pairwise Plots

```{r}
plot_e_space(
  env_bg = env_df_plotting,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  labels = c("Mean Temperature (°C)", "Temp. Seasonality", "Annual Precipitation (mm)"),
  niche = my_niche,
  plot.3d = FALSE
)
```

#### 3.2. 3D Interactive Plot

```{r, rgl=TRUE, eval = FALSE}
# This code will generate an interactive plotly plot,
# which cannot be directly embedded in static markdown but is great for exploration.
plot_e_space(
  env_bg = env_df_plotting,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  labels = c("Mean Temperature (°C)", "Temp. Seasonality", "Annual Precipitation (mm)"),
  niche = my_niche,
  plot.3d = TRUE
)
```

### 4. Extract Suitable Environments and Sample Occurrences The

get_suitable_env() function identifies all environmental points that
fall within your niche, while get_sample_occ() samples a subset of these
points with a specified bias.

```{r}
# Extract suitable environmental areas as a spatial raster
suitable_g_space <- get_suitable_env(
  niche = my_niche,
  env_bg = env_stack, # Use the raster stack for spatial output
  out = "spatial"
)

# Plot the suitable area on a map
plot(suitable_g_space, main = "Suitable Geographic Environment", 
     col = rev(terrain.colors(10)))
```

Now, let's sample some occurrences within this suitable area.

```{r}
# Sample 500 occurrences, biased towards the center of the niche
sampled_occ_center <- get_sample_occ(
  n_occ = 500,
  niche = my_niche,
  env_bg = env_stack, # Can use raster or data.frame here
  method = "center",
  seed = 42
)

plot(suitable_g_space, main = "Suitable Geographic Environment", 
     col = rev(terrain.colors(10)))
# Overlay sampled points on the geographic suitable area map
points(sampled_occ_center$x, sampled_occ_center$y,
       pch = 20, col = "red", cex = 0.6)
```

Visualize Sampled Occurrences in Environmental Space You can integrate
these simulated occurrences back into your environmental space plots.

```{r, rgl=TRUE}
# Plot in 2D
plot_e_space(
  env_bg = env_df_plotting,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  niche = my_niche,
  occ_pts = sampled_occ_center,
  show.occ.density = TRUE # Show marginal density plots for occurrences
)

# Plot in 3D, toggle option plot.3d = TRUE
plot_e_space(
  env_bg = env_df_plotting,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  niche = my_niche,
  occ_pts = sampled_occ_center,
  plot.3d = TRUE)

```


Finally, we visualize all objects in one visualization.

```{r, rgl=TRUE}
# Plot in 2D
plot_e_space(
  env_bg = env_df_plotting,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  niche = my_niche,
  occ_pts = sampled_occ_center,
  show.pts.in = TRUE, # Highlight background points within niche
  show.occ.density = TRUE,
  palette = "default"# Show marginal density plots for occurrences
)

```


Try some of the other color palettes within the Package!! 

```{r echo=FALSE, rgl=TRUE}

  palettes <- list(

  default = list(
    bg           = "#9093A2FF",
    ellipsoid    = "#2A363BFF",
    centroid     = "#D72000FF",
    tolerance    = "#EE6100FF",
    suitable_env = "#FED789FF",
    occ          = "#B4BF3AFF"),

  palette2 = list(
    bg           = "#9CA9BAFF",
    ellipsoid    = "#3D619DFF",
    centroid     = "#345084FF",
    tolerance    = "#693829FF",
    suitable_env = "#CFB267FF",
    occ          = "#A56A3EFF"),


  palette3 = list(
    bg           = "#C8CCC6FF",
    ellipsoid    = "#023743FF",
    centroid     = "#72874EFF",
    tolerance    = "#476F84FF",
    suitable_env = "#FED789FF",
    occ          = "#A4BED5FF"),

  palette4 = list(
    bg           = "#C0D1CEFF",
    ellipsoid    = "#859B6CFF",
    centroid     = "#B74954FF",
    tolerance    = "#A99364FF",
    suitable_env = "#C2DDB2FF",
    occ          = "#EBA49EFF"),

  palette5 = list(
    bg           = "#A89F8EFF",
    ellipsoid    = "#7887A4FF",
    centroid     = "#A8CDECFF",
    tolerance    = "#682C37FF",
    suitable_env = "#F6955EFF",
    occ          = "#9B6981FF"),


  palette6 = list(
    bg           = "#D3D4D8FF",
    ellipsoid    = "#731A12FF",
    centroid     = "#F2D43DFF",
    tolerance    = "#3F858CFF",
    suitable_env = "#D9814EFF",
    occ          = "#707322FF")

  )

df <- do.call(rbind, lapply(names(palettes), function(pname) {
  data.frame(
    palette = pname,
    role    = names(palettes[[pname]]),
    color   = unlist(palettes[[pname]]),
    stringsAsFactors = FALSE
  )
}))

ggplot(df, aes(x = role, y = palette, fill = color)) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = color), color = "white", size = 3.5) +
  scale_fill_identity() +
  theme_minimal() +
  labs(x = NULL, y = NULL, title = "Palette comparison") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )


plot_e_space(
  env_bg = env_df_plotting,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  niche = my_niche,
  show.pts.in = TRUE, # Highlight background points within niche
  occ_pts = sampled_occ_center,
  show.occ.density = TRUE,
  palette = "palette4"# Show marginal density plots for occurrences
)

plot_e_space(
  env_bg = env_df_plotting,
  x = "mean_temp",
  y = "temp_seasonality",
  z = "annual_precip",
  niche = my_niche,
  show.pts.in = TRUE, # Highlight background points within niche
  occ_pts = sampled_occ_center,
  show.occ.density = TRUE,
  palette = "palette6"# Show marginal density plots for occurrences
)

```


### Contributing 
We welcome contributions! If you have suggestions, bug
reports, or would like to contribute code, please feel free to open an
issue or submit a pull request on the NicheR GitHub repository.
